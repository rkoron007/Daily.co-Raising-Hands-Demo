<html>
  <head>
    <title>Classroom Hand Raising Demo</title>
    <!-- daily.co library, bundled and minimized -->
    <script src="https://unpkg.com/@daily-co/daily-js"></script>
    <script type="text/javascript" src="./dist.bundle.js"></script>
    <link rel="stylesheet" type="text/css" href="./app.css" />
  </head>
  <body onload="setupBtns()">
    <div class="participants">
      <h2>Call Participants:</h2>
      <ul id="participants-list"></ul>
    </div>

    <div class="call-buttons">
      <button id="create-room-and-frame" onclick="createFrameAndRoom()">
        Create/Join a Meeting Room
      </button>
      <div id="meeting-room-info" class="info"></div>
      <button id="join-meeting-teacher" onclick="joinCallTeacher()">
        Join as Teacher (you can't raise your hand since you are the main
        speaker!)
      </button>
      <button id="join-meeting-student" onclick="joinCallStudent()">
        Join as a student (you can raise your hand)
      </button>
      <button id="leave-meeting" onclick="callFrame.leave()">
        Leave Meeting
      </button>
      <button id="raise-hand-btn" onclick="raiseHand()">
        Raise Your Hand!
      </button>
      <button id="lower-hand-btn" onclick="lowerHand()">
        Lower Your Hand!
      </button>
    </div>
    <script>
      // initially hide these buttons until we have a room setup
      function setupBtns() {
        buttonDisable(
          "join-meeting-teacher",
          "join-meeting-student",
          "raise-hand-btn",
          "leave-meeting",
          "lower-hand-btn"
        );
      }

      // update the list of users in the call and their hand state
      function updateParticipantList(e) {
        showEvent(e);
        const participantList = document.getElementById("participants-list");
        const participants = callFrame.participants();
        let listHtml = "";

        for (let id in participants) {
          let participant = participants[id];
          let handRaised;
          // the owner of this meeting is the teacher and can therefore
          // not raise their own hand
          if (participant.owner) {
            handRaised = "";
          } else {
            // otherwise a student will only have their hand raised if
            // their camera is on
            handRaised = participant.video ? "âœ‹" : "";
          }
          listHtml += `
          <li>
            <p>${participant.user_name || "guest"} ${handRaised}</p>
           </li>`;
        }
        participantList.innerHTML = listHtml;
      }

      // create our video frame - this will enable us to connect to a meeting
      // later
      async function createFrame() {
        callFrame = window.DailyIframe.createFrame();

        callFrame
          .on("left-meeting", emptyParticipantList)
          .on("join-meeting", updateParticipantList)
          .on("participant-joined", updateParticipantList)
          .on("participant-updated", updateParticipantList)
          .on("participant-left", updateParticipantList)
          .on("error", showEvent);
      }

      // check and see if we have a pre-existing meeting room in our url
      function checkForExistingRoom(url) {
        let urlStartIdx = url.indexOf("?name=");
        if (urlStartIdx > -1) {
          // if we do - we'll extract the room name after the "?name="
          let decodedRoomName = decodeURIComponent(url.slice(urlStartIdx + 6));
          return decodedRoomName;
        }
        return false;
      }

      // this function will ensure we have a room object available
      async function createRoom() {
        let room;
        let roomNameExists = checkForExistingRoom(document.location.href);
        // if we have a room we will fetch that room's information
        if (roomNameExists) {
          room = await fetchRoom(roomNameExists);
          buttonEnable("join-meeting-student");
        } else {
          // with no room we need to create a new room
          // we'll create this in owner_only_broadcast so that only the owner
          // will have the ability to turn off and on their camera and audio
          // (since they are the teacher)
          room = await createMtgRoom({
            owner_only_broadcast: true
          });

          // we then generate a link for the "owner" of this meeting to join
          // (i.e in this case the teacher)
          window.ownerLink = await createMtgLinkWithToken({
            room_name: room.name,
            is_owner: true,
            start_audio_off: false,
            start_video_off: false
          });

          // update our ui with our new room url link
          updateRoomUrlDisplay();
          // the user can then choose:
          // A. join as the teacher (the owner of the meeting)
          // B. join as a student
          buttonEnable("join-meeting-teacher", "join-meeting-student");
        }
      }

      // create our meeting room and prepare our call to connect
      async function createFrameAndRoom() {
        await createRoom();
        await createFrame();
        buttonDisable("create-room-and-frame");
      }

      function raiseHand() {
        // find the id of the person raising their hand
        let currentUserId = callFrame.participants().local.session_id;
        // raising the hand of a student will turn their camera and video on
        // and this will also trigger the "participant-updated" event
        callFrame.updateParticipant(currentUserId, {
          setAudio: true,
          setVideo: true
        });
        buttonDisable("raise-hand-btn");
        buttonEnable("lower-hand-btn");
      }

      function lowerHand() {
        let currentUserId = callFrame.participants().local.session_id;
        // lowering the hand of a student will turn their camera and video off
        // this will also trigger the "participant-updated" event
        callFrame.updateParticipant(currentUserId, {
          setAudio: false,
          setVideo: false
        });
        buttonEnable("raise-hand-btn");
        buttonDisable("lower-hand-btn");
      }
    </script>
  </body>
</html>
