<html>
  <head>
    <title>Classroom Hand Raising Demo</title>
    <!-- this library, bundled and minimized -->
    <script src="https://unpkg.com/@daily-co/daily-js"></script>
    <script src="./keys.js"></script>
    <script src="./util/api-functions.js"></script>
    <script src="./util/ui-functions.js"></script>
    <link rel="stylesheet" type="text/css" href="app.css" />
  </head>
  <body onload="setupBtns()">
    <div class="participants">
      <h2>Call Participants:</h2>
      <ul id="participants-list"></ul>
    </div>

    <div class="call-buttons">
      <button id="create-room-and-frame" onclick="createFrameAndRoom()">
        Create/Join a Meeting Room
      </button>
      <div id="meeting-room-info" class="info"></div>
      <button id="join-meeting-teacher" onclick="joinCallTeacher()">
        Join as Teacher (you can't raise your hand since you are the main
        speaker!)
      </button>
      <button id="join-meeting-student" onclick="joinCallStudent()">
        Join as a student (you can raise your hand)
      </button>
      <button id="leave-meeting" onclick="callFrame.leave()">
        Leave Meeting
      </button>
      <button id="raise-hand-btn" onclick="raiseHand()">
        Raise Your Hand!
      </button>
      <button id="lower-hand-btn" onclick="lowerHand()">
        Lower Your Hand!
      </button>
    </div>

    <script>
      function setupBtns() {
        buttonDisable(
          "join-meeting-teacher",
          "join-meeting-student",
          "raise-hand-btn",
          "leave-meeting",
          "lower-hand-btn"
        );
      }

      // update the list of users in the call and their hand state
      function updateParticipantList(e) {
        showEvent(e);
        const participantList = document.getElementById("participants-list");
        const participants = callFrame.participants();
        let listHtml = "";

        for (let id in participants) {
          let participant = participants[id];
          let handRaised;
          if (participant.owner) {
            handRaised = "";
          } else {
            handRaised = participant.video ? "âœ‹" : "";
          }
          listHtml += `
          <li>
            <p>${participant.user_name || "guest"} ${handRaised}</p>
           </li>`;
        }
        participantList.innerHTML = listHtml;
      }

      async function createFrame() {
        window.callFrame = window.DailyIframe.createFrame();

        callFrame
          .on("app-message", e => {
            updateParticipantList;
          })
          .on("leave-meeting", e => {
            updateParticipantList;
          })
          .on("participant-joined", updateParticipantList)
          .on("participant-updated", updateParticipantList)
          .on("participant-left", updateParticipantList)
          .on("error", showEvent);
      }

      function checkForExistingRoom(url) {
        // check and see if we have a pre-existing meeting room
        let urlStartIdx = url.indexOf("?name=");
        if (urlStartIdx > -1) {
          // if we do - we'll extract the room name after the "?name="
          let decodedRoomName = decodeURIComponent(url.slice(urlStartIdx + 6));
          return decodedRoomName;
        }
        return false;
      }

      async function createRoom() {
        let room;
        let roomNameExists = checkForExistingRoom(document.location.href);
        if (roomNameExists) {
          room = await fetchRoom(roomNameExists);
          buttonEnable("join-meeting-student");
        } else {
          room = await createMtgRoom({
            start_video_off: true,
            start_audio_off: true,
            max_participants: 10
          });

          buttonEnable("join-meeting-teacher", "join-meeting-student");
          updateRoomInfoDisplay();
          window.ownerLink = await createMtgLinkWithToken({
            room_name: room.name,
            is_owner: true,
            start_audio_off: false,
            start_video_off: false
          });
        }
      }

      async function createFrameAndRoom() {
        await createRoom();
        await createFrame();
        buttonDisable("create-room-and-frame");
      }

      function raiseHand() {
        let currentUserId = callFrame.participants().local.session_id;
        callFrame.updateParticipant(currentUserId, {
          setAudio: true,
          setVideo: true
        });
        buttonDisable("raise-hand-btn");
        buttonEnable("lower-hand-btn");
      }

      function lowerHand() {
        let currentUserId = callFrame.participants().local.session_id;
        callFrame.updateParticipant(currentUserId, {
          setAudio: false,
          setVideo: false
        });
        buttonEnable("raise-hand-btn");
        buttonDisable("lower-hand-btn");
      }
    </script>
  </body>
</html>
