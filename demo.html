<html>
  <head>
    <title>Hand Raising Demo</title>
    <!-- this library, bundled and minimized -->
    <script src="https://unpkg.com/@daily-co/daily-js"></script>
    <script src="./keys.js"></script>
    <script src="./create-demo-room.js"></script>
    <script src="./util.js"></script>
    <style>
      .disabled {
        display: none;
      }
    </style>
  </head>
  <body onload="setupBtns()">
    <div class="participants">
      <h2>Call Participants List:</h2>
      <ul id="participants-list"></ul>
    </div>

    <div class="call-buttons">
      <button id="create-room-and-frame" onclick="createFrameAndRoom()">
        Create a Meeting Room
      </button>
      <div id="meeting-room-info" class="info">
        room info
      </div>
      <button
        id="join-meeting-owner"
        onclick="callFrame.join({ url: ownerLink });"
      >
        Join as Owner
      </button>
      <button
        id="join-meeting-regular"
        onclick="callFrame.join({ url: room.url });"
      >
        Join as regular participant
      </button>
      <button id="leave-meeting" onclick="callFrame.leave()">
        Leave Meeting
      </button>
      <button id="raise-hand-btn" onclick="raiseHand()">
        Raise Your Hand!
      </button>
    </div>

    <script>
      function setupBtns() {
        buttonDisable(
          "join-meeting-owner",
          "join-meeting-regular",
          "raise-hand-btn",
          "leave-meeting"
        );
      }

      // update the list of users in the call and their hand state
      function updateParticipantList(e) {
        showEvent(e);
        const participantList = document.getElementById("participants-list");
        const participants = callFrame.participants();
        let listHtml = "";

        for (let id in participants) {
          let p = participants[id];
          let handRaised = participants[video] ? "✋" : "";
          listHtml += `
            <li>
              <p>${p.user_name || "guest"}
                <span id="${p.session_id}-hand">${handRaised}</span>
              </p>
            </li>
          `;
        }
        participantList.innerHTML = listHtml;
      }

      async function createFrame() {
        window.callFrame = window.DailyIframe.createFrame({});

        callFrame
          .on("app-message", e => {
            showEvent(e);
            updateRaiseHandUI(e);
          })
          .on("join-meeting", e => {
            // this is where I'll need to update my UI for hands
            showEvent(e);
          })
          .on("participant-joined", updateParticipantList)
          .on("participant-updated", updateParticipantList)
          .on("participant-left", updateParticipantList)
          .on("error", showEvent);
      }

      async function createRoom() {
        room = await createMtgRoom({
          start_video_off: true,
          start_audio_off: true
        });

        window.ownerLink = await createMtgLinkWithToken({
          room_name: room.name,
          is_owner: true,
          start_audio_off: false,
          start_video_off: false
        });
        updateRoomInfoDisplay();
      }

      async function createFrameAndRoom() {
        await createRoom();
        await createFrame();
        buttonDisable("create-room-and-frame");
        buttonEnable(
          "join-meeting-owner",
          "join-meeting-regular",
          "raise-hand-btn",
          "leave-meeting"
        );
      }

      function raiseHand() {
        let currentUserId = callFrame.participants().local.session_id;
        callFrame.updateParticipant(currentUserId, { setVideo: true });
        console.log(callFrame.participants());
        callFrame.sendAppMessage({
          sessionId: currentUserId
        });
      }

      function updateRaiseHandUI({ data: { sessionId } }) {
        let raiseHandBtn = document.getElementById(`${sessionId}-hand`);
        let newHtml = raiseHandBtn.innerHTML === "" ? "✋" : "";
        raiseHandBtn.innerHTML = newHtml;
      }
    </script>
  </body>
</html>
